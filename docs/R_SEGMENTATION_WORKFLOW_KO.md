# R 세그먼트 생성/묶음 워크플로우 개요

아래 내용은 제공된 R 스크립트가 구분변수·니즈 데이터를 세그먼트 단위로 전처리하고, 계층적 군집화를 이용해 묶어가는 흐름을 한국어로 정리한 것입니다. 코드 구조를 고치지 않고 이해만 돕기 위해 작성했습니다.

## 1. 데이터 준비
- 원본 설문 SAV 파일을 불러와 `data` 데이터프레임으로 변환합니다.
- 니즈 요인분석 결과 CSV를 불러와 `factored_needs`(각 FAC 열)만 남기고, 한국어 니즈 변수명(`N_스트레스관리균형`, …, `N_술연관`)으로 컬럼명을 교체합니다.

## 2. 니즈 점수 리코딩
- O5~O9, O10 응답값을 기반으로 `needs_XXX` 변수를 0/1/2로 채우는 더미-스코어를 생성합니다.
  - 상위 3순위 응답값은 2점, 4~15순위 응답값은 1점, 나머지는 0점으로 설정합니다.
- 리코딩된 니즈 행렬은 후속 요인분석·타깃 분포 계산에 사용됩니다.

## 3. 구분변수 리코딩 및 결합
- 성별(SQ3), 연령(SQ4R), 직업(DE5), 언제(O1), 어디서(O2), 누구랑(O3), 무엇을 하다가(O4), 주류 고려(O16)을 각각 한국어 라벨로 변환해 `_rev` 열을 만듭니다.
- 세부 조합 생성 예시
  - `seg_Gen_Age_Job = SQ3_rev + seg_Age + seg_Job`
  - `seg_When_Where = seg_When + seg_Where`
  - `seg_With_What_Sul = seg_With + seg_What + O16_rev`
  - `seg_Spacetime_Action = seg_DEMO_WhenWhere_rev + seg_With_What_Sul_rev`
- 이렇게 만든 조합 컬럼은 계층적 군집 입력으로 사용되며, 숫자 코드 대신 한국어 라벨을 그대로 유지합니다.

## 4. 타깃×세그 분포 테이블 생성
- 각 타깃 변수(`C2_rev` + 니즈 바이너리)와 세그 변수를 짝지어 `dcast`(피벗)를 실행해 행=타깃, 열=세그 조합, 값=해당 교차 빈도(count) 테이블을 만듭니다.
- 열 단위 합이 1이 되도록 정규화해 군집 간 비교 시 규모 차이 영향을 줄입니다.

## 5. 계층적 군집화(Hclust)
- 정규화된 피벗 테이블을 전치해 "세그 조합"을 행, "타깃 분포"를 열로 갖는 행렬을 만든 뒤 유클리드 거리로 거리 행렬을 계산합니다.
- `hclust(..., method = "complete")`로 덴드로그램을 만들고, 도메인 판단으로 적정 `k` 값을 정해 `cutree`로 클러스터를 자릅니다.
- 각 세그 조합별로 할당된 클러스터 ID를 다시 원본 데이터프레임에 조인하여 `cluster_*` 컬럼으로 저장합니다.

## 6. 재라벨링 및 재묶기
- 팀 검토 후 클러스터 결과를 CSV/엑셀로 내보내 재라벨(`seg_rev`, `seg_rev2` 등)한 뒤, 해당 매핑을 읽어들여 최종 세그 라벨 컬럼을 붙입니다.
- 최종적으로 `userID`, `productSeq` 등 식별자와 모든 세그 라벨/클러스터 컬럼을 엑셀 파일(`최종_롯데칠성(음료)_ID별 seg.xlsx`)로 출력합니다.

## 7. Segments-as-points 시각화 관점
- 모든 구분변수 조합(예: "남성|20대|동반자=가족")이 `dcast`→정규화→hclust→cutree 과정을 거쳐 **각각 하나의 점(세그 조합)**으로 유지됩니다.
- 조합 값이 숫자 코드가 아닌 한국어 라벨이라도 그대로 컬럼명/행명에 쓰이므로 필터링 없이 전부 플롯에 나타나, 어떤 조합이 어느 클러스터에 묶였는지 한눈에 볼 수 있게 설계되어 있습니다.

## 8. MDS란 무엇인가?
- MDS(Multi-Dimensional Scaling, 다차원 척도법)는 고차원 거리를 최대한 보존하면서 2D/3D 저차원 좌표로 임베딩하는 기법입니다.
- PCA가 분산을 기준으로 축을 찾는 데 비해, MDS는 사전에 계산한 거리 행렬(예: 세그 조합 간 유클리드 거리)을 입력받아 거리 구조를 유지하는 좌표를 직접 추정합니다.
- 세그 조합이 2개 미만이거나 PCA 입력 차원이 부족할 때도 MDS는 거리 행렬만 있으면 작동하기 때문에, 시각화에서 유연한 대안으로 쓰입니다.

## 요약
- R 스크립트는 원자료를 한국어 라벨 세그 조합으로 확장한 뒤, 타깃×세그 분포 기반 거리→계층적 군집→재라벨링 순서로 모든 세그 조합을 묶어 나갑니다.
- 조합별 점을 하나도 버리지 않으므로 Segments-as-points 모드에서 전체 조합이 그대로 시각화됩니다.
- PCA 대신 MDS를 쓰면 거리 기반으로 좌표를 만들 수 있어, 입력 변수가 부족하거나 세그 수가 적을 때도 안정적으로 2D 임베딩을 얻을 수 있습니다.
